<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ãƒ•ãƒ¤ã‚»ãƒ«äºˆç´„ç®¡ç†ï¼†ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* --- åŸºæœ¬è¨­å®šï¼ˆä¿æŒï¼‰ --- */
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP", sans-serif;
      background: #f5f7fb;
      padding: 20px;
    }

    /* --- ä¸Šéƒ¨ï¼šäºˆç´„ãƒªã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .list-container {
      max-width: 800px;
      margin: 0 auto 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    
    /* â˜…ä¿®æ­£ï¼šãƒœã‚¿ãƒ³ã‚’ã€Œç¨‹ã‚ˆã„ã‚µã‚¤ã‚ºã€ã§æŠ˜ã‚Šè¿”ã™ã‚ˆã†ã«èª¿æ•´ */
    .filter-area {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap; 
    }

    .btn-filter {
      padding: 10px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      background: #f0f2f5;
      color: #555;
      font-size: 13px;
      transition: background 0.2s;
      /* ã‚¹ãƒãƒ›ã§ç¸¦é•·ã«ãªã‚Šã™ããªã„ã‚ˆã†ã€å¹…ã‚’èª¿æ•´ */
      width: calc(33% - 6px); /* 3åˆ—è¡¨ç¤º */
      min-width: 90px;
      text-align: center;
    }
    /* ç”»é¢ãŒå°ã•ã„æ™‚ã¯2åˆ—ã« */
    @media (max-width: 500px) {
      .btn-filter { width: calc(50% - 5px); }
    }

    .btn-filter:hover { background: #e4e6eb; }
    .btn-filter.active { background: #2563eb; color: #fff; }

    .search-area { margin-bottom: 10px; }
    .search-area input { margin-top: 0; }
    
    .table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 13px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; }
    tr.clickable { cursor: pointer; transition: background 0.1s; }
    tr.clickable:hover { background-color: #e3f2fd; }
    tr.selected { background-color: #bbdefb; border-left: 5px solid #2563eb; }

    /* --- ä¸‹éƒ¨ï¼šç”Ÿæˆãƒ„ãƒ¼ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå®Œå…¨ã«ä¿æŒï¼‰ --- */
    .box {
      max-width: 520px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }

    h1 { font-size: 18px; margin: 0 0 16px; }
    h2 { font-size: 16px; margin: 0 0 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 8px;}

    label { display: block; margin-top: 12px; font-size: 13px; color: #555; }

    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid #d7dbe6;
      background: #fff;
    }

    .dateWrap { position: relative; }
    input[type="date"] { padding-right: 12px; }
    input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 0; position: absolute; right: 0; top: 0; width: 100%; height: 100%; cursor: pointer;
    }

    .btnRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    button { border: none; cursor: pointer; font-weight: 800; background: #2563eb; color: #fff; }
    button.secondary { background: #111827; }
    button:hover { opacity: .92; }
    .mini { margin-top: 10px; font-size: 12px; color: #667085; }
    
    textarea {
      height: 260px; margin-top: 12px; font-size: 14px; line-height: 1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Noto Sans Mono", monospace;
      white-space: pre-wrap;
    }
    .status { margin-top: 8px; font-size: 12px; color: #0f766e; min-height: 16px; }

  </style>
</head>

<body>

  <div class="list-container">
    <h2>ğŸ“… äºˆç´„ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</h2>
    
    <div class="filter-area" id="dateButtonsContainer"></div>

    <div class="search-area">
      <input type="text" id="searchInput" placeholder="åå‰ã§æ¤œç´¢...">
    </div>
    
    <div id="loading" style="font-size:12px; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="table-wrapper">
      <table id="customerTable" style="display:none;">
        <thead>
          <tr>
            <th>æ¥åº—æ—¥</th>
            <th>æ™‚é–“</th>
            <th>ãŠåå‰</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          </tbody>
      </table>
    </div>
  </div>


  <div class="box" id="toolBox">
    <h1>ğŸ—“ é¢è«‡ãƒ¡ãƒ¢ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>

    <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</label>
    <div class="dateWrap">
      <input type="date" id="date">
    </div>

    <label>é–‹å§‹æ™‚é–“ï¼ˆ10ã€œ17æ™‚ï¼‰</label>
    <select id="time"></select>

    <label>é¢è«‡æ–¹æ³•</label>
    <select id="method">
      <option>Google Meet</option>
      <option>é›»è©±</option>
      <option>LINE</option>
      <option>ãƒ¡ãƒ¼ãƒ«</option>
    </select>

    <div class="btnRow">
      <button id="copyAllBtn">å…¨æ–‡ã‚³ãƒ”ãƒ¼ï¼ˆé€ä¿¡ç”¨ï¼‰</button>
      <button class="secondary" id="copyDateBtn">æ—¥æ™‚ã ã‘ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="status" id="status"></div>

    <div class="mini">ä¸‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ï¼ˆãã®ã¾ã¾è²¼ã‚Šä»˜ã‘OKï¼‰</div>
    <textarea id="preview" readonly></textarea>
  </div>

<script>
(() => {
  // --- 1. ãƒ„ãƒ¼ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¿æŒï¼‰ ---
  const week = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const LINE = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";

  const dateEl = document.getElementById("date");
  const timeEl = document.getElementById("time");
  const methodEl = document.getElementById("method");
  const previewEl = document.getElementById("preview");
  const statusEl = document.getElementById("status");
  const copyAllBtn = document.getElementById("copyAllBtn");
  const copyDateBtn = document.getElementById("copyDateBtn");

  function buildTimes() {
    timeEl.innerHTML = "";
    for (let h = 5; h <= 23; h++) {
      const opt = document.createElement("option");
      opt.value = String(h);
      opt.textContent = `${h}æ™‚ï½é¢è«‡é–‹å§‹`;
      if(h === 10) opt.selected = true;
      timeEl.appendChild(opt);
    }
  }

  function setToday() {
    const t = new Date();
    const yyyy = t.getFullYear();
    const mm = String(t.getMonth()+1).padStart(2,"0");
    const dd = String(t.getDate()).padStart(2,"0");
    dateEl.value = `${yyyy}-${mm}-${dd}`;
  }

  function fmtDateParts() {
    const v = dateEl.value;
    if (!v) return null;
    const d = new Date(v + "T00:00:00");
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    const day = d.getDate();
    const dow = week[d.getDay()];
    const h = Number(timeEl.value || 10);
    const method = methodEl.value;
    return { y, m, day, dow, h, method };
  }

  function buildDateBox() {
    const p = fmtDateParts();
    if (!p) return "";
    return `${LINE}
é¢è«‡äºˆç´„æ—¥æ™‚
${p.y}å¹´${p.m}æœˆ${p.day}æ—¥ï¼ˆ${p.dow}ï¼‰
${p.h}æ™‚ï½é¢è«‡é–‹å§‹
æ–¹æ³•ï¼š${p.method}
${LINE}`;
  }

  function buildFullMessage() {
    const p = fmtDateParts();
    if (!p) return "";
    const dateBox = buildDateBox();
    
    return `ãƒ•ãƒ¤ã‚»ãƒ«ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚
ã”é€£çµ¡ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

${dateBox}

ã”æŒ‡å®šã®ãŠæ™‚é–“ã«
ç©ºãæ ãŒã”ã–ã„ã¾ã—ãŸã®ã§
ä¸Šè¨˜æ—¥ç¨‹ã«ã¦é¢è«‡ã«
å…¥ã‚‰ã›ã¦ã„ãŸã ãã¾ã™ã€‚

é¢è«‡ã®éš›ã«ã¯

ã€Œãƒ•ãƒ¤ã‚»ãƒ«AIã®æº–å‚™ã€
ã€ŒèããŸã„ã“ã¨ã€
ã€Œã‚µãƒãƒ¼ãƒˆã‚’å—ã‘ãŸã„ã“ã¨ã€

ã“ã¡ã‚‰ã‚’ã”ç”¨æ„ãƒ»ã”æº–å‚™ã®ã†ãˆ
ã”å‚åŠ ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

ãã®é–“ã§ã‚‚
ã”è³ªå•ãªã©ãŒã”ã–ã„ã¾ã—ãŸã‚‰

ã—ã£ã‹ã‚Šä¸å¯§ã«ã‚µãƒãƒ¼ãƒˆå¯¾å¿œã‚’
ã•ã›ã¦ã„ãŸã ãã¾ã™ã®ã§

ã”ä¸æ˜ç‚¹ãŒã”ã–ã„ã¾ã™å ´åˆã¯
ãŠå•ã„åˆã‚ã›ãã ã•ã„ã¾ã›ã€‚

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
  }

  function renderPreview() {
    const text = buildFullMessage();
    previewEl.value = text || "æ—¥ä»˜ã‚’é¸ã¶ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‡ºã¾ã™";
    statusEl.textContent = "";
  }

  async function copyText(text, okMsg) {
    if (!text) {
      statusEl.textContent = "æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„";
      statusEl.style.color = "#b45309";
      return;
    }
    try {
      await navigator.clipboard.writeText(text);
      statusEl.textContent = okMsg;
      statusEl.style.color = "#0f766e";
    } catch {
      previewEl.focus();
      previewEl.select();
      document.execCommand("copy");
      statusEl.textContent = okMsg + "ï¼ˆäº’æ›ã‚³ãƒ”ãƒ¼ï¼‰";
      statusEl.style.color = "#0f766e";
    }
    setTimeout(() => statusEl.textContent = "", 1500);
  }

  dateEl.addEventListener("change", renderPreview);
  timeEl.addEventListener("change", renderPreview);
  methodEl.addEventListener("change", renderPreview);

  copyAllBtn.addEventListener("click", () => copyText(buildFullMessage(), "å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
  copyDateBtn.addEventListener("click", () => copyText(buildDateBox(), "æ—¥æ™‚ã ã‘ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));

  buildTimes();
  setToday();
  renderPreview();


  // --- 2. äºˆç´„ãƒªã‚¹ãƒˆé€£æºæ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
  const API_URL = "https://script.google.com/macros/s/AKfycbzUynvjJBAh2vCS_umO_I5_b4EsN5l6KnApahCpoY2EM9zGhrJAWrB2rUarBlSPzZoK/exec";
  let allData = [];

  // â˜…ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šå®‰å…¨ãªæ—¥ä»˜æ–‡å­—åˆ—å¤‰æ› (YYYY.MM.DD -> YYYY-MM-DD)
  function safeDateStr(str) {
    if(!str) return "";
    // æ­£è¦è¡¨ç¾ã§æ•°å­—ã®ä¸¦ã³(YYYY, MM, DD)ã‚’å¼·åˆ¶çš„ã«æŠ½å‡ºã™ã‚‹
    // ä¾‹: "2026.01.20 (ç«)" -> matches ["2026", "01", "20"]
    const match = str.match(/(\d{4})[\.\/\-](\d{1,2})[\.\/\-](\d{1,2})/);
    if(match) {
        return `${match[1]}-${match[2]}-${match[3]}`; // "2026-01-20"
    }
    return "";
  }

  function initDateButtons() {
    const container = document.getElementById('dateButtonsContainer');
    container.innerHTML = "";

    for(let i=0; i<=6; i++) {
        const d = new Date();
        d.setDate(d.getDate() + i);
        
        let label = "";
        if(i === 0) label = "ä»Šæ—¥";
        else if(i === 1) label = "æ˜æ—¥";
        else if(i === 2) label = "æ˜å¾Œæ—¥";
        else label = `${i}æ—¥å¾Œ`;
        
        const y = d.getFullYear();
        const m = ('0' + (d.getMonth()+1)).slice(-2);
        const day = ('0' + d.getDate()).slice(-2);
        const dateStr = `${y}.${m}.${day}`; // æ¤œç´¢ç”¨(ã‚¹ãƒ—ã‚·ã«åˆã‚ã›ã‚‹)

        const btn = document.createElement("button");
        btn.className = "btn-filter";
        btn.textContent = `${label} (${m}/${day})`;
        if(i === 0) btn.classList.add("active");
        
        btn.onclick = () => {
            document.querySelectorAll(".btn-filter").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            filterListByDate(dateStr);
        };
        
        container.appendChild(btn);
    }

    const btnAll = document.createElement("button");
    btnAll.className = "btn-filter";
    btnAll.style.width = "100%"; // å…¨ã¦è¡¨ç¤ºã¯å¤§ãã
    btnAll.textContent = "å…¨ã¦è¡¨ç¤º";
    btnAll.onclick = () => {
        document.querySelectorAll(".btn-filter").forEach(b => b.classList.remove("active"));
        btnAll.classList.add("active");
        renderList(sortDataByTime(allData));
    };
    container.appendChild(btnAll);
  }

  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      initDateButtons();
      
      const today = new Date();
      const y = today.getFullYear();
      const m = ('0' + (today.getMonth()+1)).slice(-2);
      const d = ('0' + today.getDate()).slice(-2);
      filterListByDate(`${y}.${m}.${d}`);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('customerTable').style.display = 'table';
    })
    .catch(err => console.error(err));

  function sortDataByTime(dataList) {
    return dataList.sort((a, b) => {
        const timeA = a[3] || "99:99"; 
        const timeB = b[3] || "99:99";
        return timeA.localeCompare(timeB);
    });
  }

  // â˜…ä¿®æ­£ï¼šã€Œ2æ™‚é–“çµŒéã€åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  function isExpired(dateStr, timeStr) {
    if(!timeStr) return false;
    
    // 1. æ—¥ä»˜ã‚’æ­£è¦åŒ–ã—ã¦Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹
    const ymd = safeDateStr(dateStr); // "2026-01-20"
    if(!ymd) return false;

    // 2. æ—¥æ™‚ã‚’çµåˆã—ã¦DateåŒ– (ä¾‹: "2026-01-20T14:00:00")
    const targetDate = new Date(`${ymd}T${timeStr}:00`);
    
    // 3. DateãŒç„¡åŠ¹ãªã‚‰é™¤å¤–ã—ãªã„
    if(isNaN(targetDate.getTime())) return false;

    // 4. 2æ™‚é–“è¶³ã™
    targetDate.setHours(targetDate.getHours() + 2);
    
    // 5. ç¾åœ¨æ™‚åˆ»ã¨æ¯”è¼ƒ
    return new Date() > targetDate;
  }

  function filterListByDate(targetDateStr) {
    // æ—¥ä»˜æ–‡å­—åˆ—ã§æ¤œç´¢ï¼ˆã“ã“ã¯éƒ¨åˆ†ä¸€è‡´ã§OKï¼‰
    let filtered = allData.filter(row => row[2] && row[2].includes(targetDateStr));

    // â˜…2æ™‚é–“çµŒéãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨
    filtered = filtered.filter(row => {
        const dStr = row[2];
        const tStr = row[3];
        // æœŸé™åˆ‡ã‚Œãªã‚‰ false (è¡¨ç¤ºã—ãªã„)
        if (isExpired(dStr, tStr)) return false;
        return true;
    });

    const sorted = sortDataByTime(filtered);
    renderList(sorted);
  }

  function renderList(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    if(data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#999; padding:20px;'>äºˆç´„ãªã— (çµ‚äº†åˆ†ã¯éè¡¨ç¤º)</td></tr>";
      return;
    }
    data.forEach(row => {
      const dStr = row[2];
      const tStr = row[3];
      const name = row[12] || row[6] || "åç§°ãªã—";
      const status = row[5];

      const tr = document.createElement('tr');
      tr.className = "clickable";
      tr.innerHTML = `<td>${dStr}</td><td>${tStr}</td><td style="font-weight:bold">${name}</td><td>${status}</td>`;
      
      // â˜…ä¿®æ­£ï¼šã‚¯ãƒªãƒƒã‚¯é€£æº
      tr.onclick = () => {
        document.querySelectorAll('tr').forEach(t => t.classList.remove('selected'));
        tr.classList.add('selected');

        // æ—¥ä»˜åæ˜ ï¼šæ­£è¦åŒ–é–¢æ•°ã‚’é€šã—ã¦ç¢ºå®Ÿã«å…¥ã‚Œã‚‹
        if(dStr) {
           const cleanDate = safeDateStr(dStr); // "2026-01-20"
           if(cleanDate) dateEl.value = cleanDate;
        }
        
        // æ™‚é–“åæ˜ 
        if(tStr) {
           const hour = parseInt(tStr);
           if(hour) timeEl.value = String(hour);
        }
        
        renderPreview();
        if(window.innerWidth < 600) {
            document.getElementById('toolBox').scrollIntoView({behavior: "smooth"});
        }
      };
      tbody.appendChild(tr);
    });
  }
  
  document.getElementById('searchInput').onkeyup = (e) => {
    document.querySelectorAll(".btn-filter").forEach(b => b.classList.remove("active"));
    const val = e.target.value.toLowerCase();
    const filtered = allData.filter(row => row.join(" ").toLowerCase().includes(val));
    renderList(sortDataByTime(filtered));
  };

})();
</script>
</body>
</html>
