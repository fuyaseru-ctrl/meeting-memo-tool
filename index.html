<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ãƒ•ãƒ¤ã‚»ãƒ«äºˆç´„ç®¡ç†ï¼†ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* --- åŸºæœ¬è¨­å®š --- */
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP", sans-serif; background: #f5f7fb; padding: 20px; }

    /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ --- */
    .main-wrapper { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1400px; margin: 0 auto; }
    .left-column { flex: 2; min-width: 500px; }
    .right-column { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 20px; }

    /* --- ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ --- */
    .list-container { background: #fff; padding: 20px; border-radius: 14px; box-shadow: 0 8px 20px rgba(0,0,0,.08); }

    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; color: #333; font-size: 1.1em; }
    .calendar-nav-btn { background: #f0f2f5; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-weight: bold; color: #555; }
    .calendar-nav-btn:hover { background: #e4e6eb; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 15px; }
    
    .cal-cell { 
        height: 60px;
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        border-radius: 8px; 
        cursor: pointer; 
        font-size: 14px; 
        color: #333; 
        position: relative; 
        background: #fff; 
        border: 1px solid transparent; 
    }
    .cal-cell:hover { filter: brightness(0.95); }
    
    .cal-sat { background-color: #eff6ff; color: #1e40af; }
    .cal-sun { background-color: #fef2f2; color: #991b1b; }
    
    .cal-head { 
        height: 30px;
        font-size: 12px; 
        color: #888; 
        font-weight: normal; 
        cursor: default; 
        background:none !important;
    }
    
    .cal-today { border: 2px solid #2563eb; font-weight: bold; }
    .cal-selected { background-color: #2563eb !important; color: #fff !important; border-color: #2563eb; }
    .cal-has-event::after { content: ""; position: absolute; bottom: 4px; width: 5px; height: 5px; border-radius: 50%; background-color: #ef4444; }
    .cal-selected.cal-has-event::after { background-color: #fff; }

    .controls-area { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;}
    .btn-sub { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: #fff; color: #555; font-size: 13px; cursor: pointer; }
    #btnTodayReset { background-color: #dcfce7; color: #14532d; border: 1px solid #86efac; font-weight: bold; }
    #btnGenerateMeet { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; }
    #btnGenerateMeetForDate { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; }
    #btnDeleteDayBatch { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; font-weight: bold; margin-left: auto; }

    .search-area { margin-bottom: 10px; }
    .search-area input { margin-top: 0; }
    
    /* â–¼â–¼â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†å‰²ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
    .table-section-title {
        margin: 30px 0 10px;
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 2px solid #eee;
        padding-bottom: 8px;
    }
    .table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; }
    
    table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 13px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
    th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; }
    tr.clickable { cursor: pointer; transition: background 0.1s; }
    tr.clickable:hover { background-color: #e3f2fd; }
    tr.selected { background-color: #bbdefb; border-left: 5px solid #2563eb; }
    tr.highlight-next { background-color: #fef9c3 !important; border-left: 5px solid #eab308; }
    tr.highlight-next.selected { background-color: #bbdefb !important; border-left: 5px solid #eab308; }
    
    .meet-link { display: inline-block; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: bold; }
    .meet-link:hover { background: #bfdbfe; }
    .account-badge { font-size: 11px; color: #666; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; display: inline-block; }
    
    .copy-link-btn { padding: 4px 8px; background: #f3f4f6; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .copy-link-btn:hover { background: #e5e7eb; }
    .copy-link-btn:active { background: #d1d5db; }

    tr.row-canceled {
        background-color: #f3f4f6 !important; 
        color: #a3a3a3 !important;             
        text-decoration: line-through;         
    }
    tr.row-canceled a,
    tr.row-canceled button,
    tr.row-canceled select { 
        opacity: 0.5;
    }

    tr.row-paid {
        background-color: #fffbeb !important; 
        color: #92400e !important;
    }
    tr.row-paid td {
        border-bottom-color: #fcd34d !important;
    }

    .common-select {
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background: #fff;
        color: #333;
        cursor: pointer;
        max-width: 120px;
    }
    .common-select:hover { border-color: #aaa; }

    .payment-summary-box {
        margin-top: 15px;
        padding: 15px;
        background-color: #fffbeb;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        color: #92400e;
        text-align: center;
    }
    .payment-total-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 8px;
    }
    .payment-detail-list {
        font-size: 13px;
        text-align: left;
        display: inline-block; 
        line-height: 1.6;
        width: 100%;
        max-width: 240px;
        border-top: 1px dashed #fcd34d;
        padding-top: 8px;
    }
    .payment-row {
        display: flex;
        justify-content: space-between;
    }

    .status-red { color: #e11d48; font-weight: bold; }
    .status-blue { color: #2563eb; font-weight: bold; }
    .status-orange { color: #d97706; font-weight: bold; }

    /* --- Box --- */
    .box { background: #fff; padding: 20px; border-radius: 14px; box-shadow: 0 8px 20px rgba(0,0,0,.08); position: relative; margin-bottom: 20px; }
    h1 { font-size: 18px; margin: 0 0 16px; display:flex; align-items:center; gap:8px; }
    label { display: block; margin-top: 12px; font-size: 13px; color: #555; }
    input, select, button, textarea { width: 100%; padding: 10px; margin-top: 6px; font-size: 15px; border-radius: 10px; border: 1px solid #d7dbe6; background: #fff; }
    .dateWrap { position: relative; }
    .btnRow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    button { border: none; cursor: pointer; font-weight: 800; background: #2563eb; color: #fff; }
    button.secondary { background: #111827; }
    button.danger { background: #ef4444; } 
    button.primary-sub { background: #4f46e5; }
    button.add-btn { background: #10b981; }
    button.delete-row-btn { background: #b91c1c; color: #fff; margin-top: 10px; }
    button:hover { opacity: .92; }
    
    .assign-btn {
        background: #8b5cf6; 
        color: #fff;
    }
    .assign-area {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    .assign-select-wrap {
        flex: 1;
    }

    textarea { height: 180px; margin-top: 12px; font-size: 14px; line-height: 1.6; font-family: monospace; white-space: pre-wrap; }
    .status { margin-top: 8px; font-size: 12px; color: #0f766e; min-height: 16px; }
    #selectedNameDisplay { font-size:12px; color:#666; position:absolute; top:20px; right:20px; font-weight:bold; }
    .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }

    @media (max-width: 900px) {
        .main-wrapper { flex-direction: column; }
        .left-column, .right-column { min-width: 100%; flex: auto; }
    }
  </style>
</head>
<body>

<div class="main-wrapper">
  
  <div class="left-column">
    <div class="list-container">
      <h2>ğŸ“… äºˆç´„ãƒªã‚¹ãƒˆ</h2>
      <div class="calendar-header">
          <button class="calendar-nav-btn" id="prevMonthBtn">ï¼œ</button>
          <span id="calendarTitle"></span>
          <button class="calendar-nav-btn" id="nextMonthBtn">ï¼</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
      
      <div class="controls-area">
          <button class="btn-sub" id="btnTodayReset">ä»Šæ—¥ã«æˆ»ã‚‹</button>
          <button class="btn-sub" id="btnShowAll">ãƒªã‚¹ãƒˆå…¨è¡¨ç¤º</button>
          <button class="btn-sub" id="btnGenerateMeet">âš¡ å…¨ä¸€æ‹¬ç™ºè¡Œ</button>
          <button class="btn-sub" id="btnGenerateMeetForDate">âš¡ è¡¨ç¤ºæ—¥ã®Meetç™ºè¡Œ</button>
          <button class="btn-sub" id="btnDeleteDayBatch">ğŸ—‘ï¸ è¡¨ç¤ºæ—¥ã®å…¨ãƒªãƒ³ã‚¯å‰Šé™¤</button>
      </div>

      <div class="search-area"><input type="text" id="searchInput" placeholder="åå‰ã§æ¤œç´¢..."></div>
      <div id="loading" style="font-size:12px; color:#666;">èª­ã¿è¾¼ã¿ä¸­...</div>

      <div class="table-section-title">ğŸ‘¨â€ğŸ’¼ å–¶æ¥­æ‹…å½“ãƒªã‚¹ãƒˆ <span style="font-size:12px; font-weight:normal; color:#666;">(äºˆç´„ç¢ºå®š)</span></div>
      <div class="table-wrapper">
        <table id="salesTable">
          <thead>
            <tr>
              <th>æ¥åº—æ—¥</th>
              <th>æ™‚é–“</th>
              <th>ãŠåå‰</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>é¢è«‡æ–¹å¼</th>
              <th>æ‹…å½“</th>
              <th>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th>
              <th>Meet</th>
              <th>ã‚³ãƒ”ãƒ¼</th>
              <th>å…¥é‡‘</th>
            </tr>
          </thead>
          <tbody id="salesTableBody"></tbody>
        </table>
      </div>

      <div class="table-section-title">ğŸ¤ ã‚µãƒãƒ¼ãƒˆæ‹…å½“ãƒªã‚¹ãƒˆ <span style="font-size:12px; font-weight:normal; color:#666;">(åˆå›ãƒ»å®šæœŸé¢è«‡ãƒ»ãã®ä»–)</span></div>
      <div class="table-wrapper">
        <table id="supportTable">
          <thead>
            <tr>
              <th>æ¥åº—æ—¥</th>
              <th>æ™‚é–“</th>
              <th>ãŠåå‰</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>é¢è«‡æ–¹å¼</th>
              <th>æ‹…å½“</th>
              <th>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th>
              <th>Meet</th>
              <th>ã‚³ãƒ”ãƒ¼</th>
              <th>å…¥é‡‘</th>
            </tr>
          </thead>
          <tbody id="supportTableBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <div class="right-column">
    
    <div class="box" id="toolBox">
      <h1>ğŸ—“ é¢è«‡ãƒ¡ãƒ¢ç”Ÿæˆ</h1>
      <div id="selectedNameDisplay"></div>

      <label>æ—¥ä»˜</label>
      <div class="dateWrap"><input type="date" id="date"></div>
      <label>é–‹å§‹æ™‚é–“</label>
      <select id="time"></select>
      <label>é¢è«‡æ–¹æ³•</label>
      <select id="method">
        <option>Google Meet</option>
        <option>é›»è©±</option>
        <option>LINE</option>
        <option>ãƒ¡ãƒ¼ãƒ«</option>
      </select>
      <div class="btnRow">
        <button id="copyAllBtn">å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>
        <button class="secondary" id="copyDateBtn">æ—¥æ™‚ã®ã¿ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="status" id="status"></div>
      <textarea id="preview" readonly></textarea>

      <div class="action-row">
          <button class="primary-sub" id="btnCreateSingle">ğŸ”— å€‹åˆ¥ãƒªãƒ³ã‚¯ç™ºè¡Œ</button>
          <button style="background:#f59e0b; color:#fff;" id="btnCancelStatus">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="danger" id="btnDeleteSingle">ğŸ—‘ï¸ ãƒªãƒ³ã‚¯å‰Šé™¤</button>
      </div>
      
      <button class="delete-row-btn" id="btnDeleteRow">âŒ äºˆç´„å‰Šé™¤</button>
      
      <button id="btnCopyReminder" style="margin-top:12px; background:#4b5563; color:#fff;">ğŸ“§ ãƒªãƒã‚¤ãƒ³ãƒ‰æ–‡ã‚³ãƒ”ãƒ¼ (30åˆ†å‰)</button>
      
      <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee;">
          <h1>ğŸ‘¨â€ğŸ’» æœ¬æ—¥ã®æ‹…å½“å‰²å½“</h1>
          <div class="assign-area">
              <div class="assign-select-wrap">
                  <label style="margin-top:0;">ç¨¼åƒäººæ•°</label>
                  <select id="assignStaffCount">
                      <option value="2">2äºº</option>
                      <option value="3">3äºº</option>
                      <option value="4" selected>4äºº</option>
                      <option value="5">5äºº</option>
                      <option value="6">6äºº</option>
                      <option value="7">7äºº</option>
                      <option value="8">8äºº</option>
                  </select>
              </div>
              <button class="assign-btn" id="btnAssignStaff" style="flex:2;">ğŸ² æ‹…å½“ã‚’å‰²ã‚ŠæŒ¯ã‚‹</button>
          </div>
          <div style="font-size:11px; color:#666; margin-top:5px;">â€»ã€Œå–¶æ¥­æ‹…å½“ãƒªã‚¹ãƒˆã€ã®ã¿å¯¾è±¡ï¼ˆãƒ„ãƒ¼ãƒ«å†…ä¿å­˜ï¼‰</div>
      </div>
    </div>

    <div class="box" id="addBox">
      <h1>ğŸ“ æ–°è¦äºˆç´„ç™»éŒ² <span style="font-size:12px;color:#666;font-weight:normal">(ã‚¹ãƒ—ã‚·ã«è¿½åŠ )</span></h1>
      <label>æ¥åº—æ—¥</label>
      <input type="date" id="addDate">
      <label>æ™‚é–“</label>
      <select id="addTime"></select>
      <label>ãŠåå‰</label>
      <input type="text" id="addName" placeholder="å±±ç”° å¤ªéƒ">
      <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <select id="addStatus">
        <option>äºˆç´„ç¢ºå®š</option>
        <option>åˆå›é¢è«‡</option>
        <option>1ãƒµæœˆé¢è«‡</option>
        <option>2ãƒµæœˆé¢è«‡</option>
        <option>3ãƒµæœˆé¢è«‡</option>
        <option>4ãƒµæœˆé¢è«‡</option>
        <option>5ãƒµæœˆé¢è«‡</option>
        <option>æº€æœŸé¢è«‡</option>
        <option>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
        <option>äºˆç´„ç¢ºå®šï¼ˆæ‰‹å‹•è¿½åŠ ï¼‰</option>
      </select>
      
      <label>é¢è«‡æ–¹å¼</label>
      <select id="addMethod">
        <option>Google Meet</option>
        <option>é›»è©±</option>
        <option>LINE</option>
        <option>ãƒ¡ãƒ¼ãƒ«</option>
        <option>ãã®ä»–</option>
      </select>

      <button class="add-btn" id="btnAddManual" style="margin-top:20px;">ï¼‹ äºˆç´„ã‚’è¿½åŠ ã™ã‚‹</button>
      
      <div id="paymentSummaryBox" class="payment-summary-box">
          <div class="payment-total-title">ğŸ’° åˆè¨ˆå…¥é‡‘ä»¶æ•°ï¼šé›†è¨ˆä¸­...</div>
          <div id="paymentDetailList" class="payment-detail-list"></div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbz3AX4cK2ViWserTlSrlBg66hiNrAxwP4xZFeWb5tFPegzfGxikb7yAH0jNXVlrezRp/exec";

  let allData = [];
  let calDate = new Date(); 
  let currentSelectedDateStr = "";
  let selectedCustomerName = ""; 
  let selectedMeetUrl = ""; 
  const week = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  
  const dateEl = document.getElementById("date");
  const timeEl = document.getElementById("time");
  const methodEl = document.getElementById("method");
  const previewEl = document.getElementById("preview");
  const statusEl = document.getElementById("status");
  const nameDisplay = document.getElementById("selectedNameDisplay");

  const addDateEl = document.getElementById("addDate");
  const addTimeEl = document.getElementById("addTime");
  const addNameEl = document.getElementById("addName");
  const addStatusEl = document.getElementById("addStatus");
  const addMethodEl = document.getElementById("addMethod");
  const paymentSummaryBox = document.getElementById("paymentSummaryBox");
  const paymentDetailList = document.getElementById("paymentDetailList");
  const assignStaffCountEl = document.getElementById("assignStaffCount");

  const normalizeMap = {
      "ã‚¯ãƒ¬ã‚«åˆ†å‰² 6åˆ†å‰²": "ã‚¯ãƒ¬ã‚« 6åˆ†å‰²",
      "ã‚¯ãƒ¬ã‚«åˆ†å‰² 12åˆ†å‰²": "ã‚¯ãƒ¬ã‚« 12åˆ†å‰²",
      "ã‚¯ãƒ¬ã‚«åˆ†å‰² 24åˆ†å‰²": "ã‚¯ãƒ¬ã‚« 24åˆ†å‰²",
      "ã‚¯ãƒ¬ã‚«åˆ†å‰² 36åˆ†å‰²": "ã‚¯ãƒ¬ã‚« 36åˆ†å‰²",
      "ã‚¯ãƒ¬ã‚«åˆ†å‰² 48åˆ†å‰²": "ã‚¯ãƒ¬ã‚« 48åˆ†å‰²"
  };

  function init() { buildTimes(); setToday(); renderPreview(); loadData(); setupEvents(); }

  function buildTimes() {
    timeEl.innerHTML = ""; addTimeEl.innerHTML = ""; 
    for (let h = 5; h <= 23; h++) {
      const opt = document.createElement("option");
      opt.value = String(h);
      opt.textContent = `${h}æ™‚ï½`;
      if(h === 10) opt.selected = true;
      timeEl.appendChild(opt);
      addTimeEl.appendChild(opt.cloneNode(true)); 
    }
  }
  function setToday() {
    const t = new Date();
    const s = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
    dateEl.value = s;
    addDateEl.value = s;
  }

  function setupEvents() {
    document.getElementById('prevMonthBtn').onclick = () => { 
        calDate.setDate(1); 
        calDate.setMonth(calDate.getMonth()-1); 
        renderCalendar(); 
    };
    document.getElementById('nextMonthBtn').onclick = () => { 
        calDate.setDate(1); 
        calDate.setMonth(calDate.getMonth()+1); 
        renderCalendar(); 
    };
    
    document.getElementById('btnTodayReset').onclick = () => {
        calDate = new Date();
        const todayStr = `${calDate.getFullYear()}.${('0'+(calDate.getMonth()+1)).slice(-2)}.${('0'+calDate.getDate()).slice(-2)}`;
        currentSelectedDateStr = todayStr;
        renderCalendar(); filterListByDate(todayStr);
    };
    document.getElementById('btnShowAll').onclick = () => {
        currentSelectedDateStr = ""; selectedCustomerName = ""; selectedMeetUrl = ""; nameDisplay.textContent = "";
        renderCalendar(); 
        renderList(sortDataByDateDesc(allData));
    };
    document.getElementById('copyAllBtn').onclick = () => copyText(buildFullMessage(), "å…¨æ–‡ã‚³ãƒ”ãƒ¼å®Œäº†");
    document.getElementById('copyDateBtn').onclick = () => copyText(buildDateBox(), "æ—¥æ™‚ã‚³ãƒ”ãƒ¼å®Œäº†");
    
    document.getElementById('btnCopyReminder').onclick = () => {
        if (!selectedCustomerName) { alert("ãƒªã‚¹ãƒˆã‹ã‚‰äººã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        
        const v = dateEl.value; 
        const tVal = timeEl.value;
        if(!v) { alert("æ—¥ä»˜ãŒç„¡åŠ¹ã§ã™"); return; }
        
        const d = new Date(v + "T00:00:00");
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const dt = d.getDate();
        const w = week[d.getDay()];
        const timeStr = tVal.includes(":") ? tVal : tVal + ":00";
        
        const formattedDateTime = `${y}å¹´${m}æœˆ${dt}æ—¥(${w}) ${timeStr}`;
        const meetUrl = selectedMeetUrl || "ï¼ˆURLæœªç™ºè¡Œï¼‰";

        const reminderText = `${selectedCustomerName}æ§˜ï¼šã”äºˆç´„ã€ 30åˆ†å‰ ã€‘ã§ã™ã€‚å‚åŠ URLã‚’ã”ç¢ºèªãã ã•ã„\n\n\nãƒ•ãƒ¤ã‚»ãƒ«ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\nãƒ•ãƒ¤ã‚»ãƒ«å¼\nãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ã‚µãƒãƒ¼ãƒˆ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâ—‡ äºˆç´„æ—¥æ™‚\nâ—†â—†â—†ãƒ¼äºˆç´„æ—¥æ™‚è¨˜å…¥ãƒ¼â—†â—†â—†\n${formattedDateTime}\n\né–‹å§‹æ™‚é–“ã€\nã€Œï¼“ï¼åˆ†å‰ã€ã«ãªã‚Šã¾ã—ãŸã®ã§\nGoogle Meet å‚åŠ ç”¨ã®URLã‚’\nãŠé€ã‚Šã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚\n\n\nâ–¼ã‚³ãƒãƒ©ã‹ã‚‰ã”å‚åŠ ãã ã•ã„\n${meetUrl}\n\näºˆç´„æ™‚é–“ã«ãªã‚Šã¾ã—ãŸã‚‰\nURLã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦\nMeetã«ã”å‚åŠ ãã ã•ã„ã€‚\n\nâ€» PCã§ã®ã”åˆ©ç”¨ â€»\nPCã§ã”åˆ©ç”¨ã«ãªã‚‹å ´åˆã¯\nã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‚’\nPCã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«\nå¼µã‚Šä»˜ã‘ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚\n\n\nã‚¨ãƒ©ãƒ™ãƒ«Ã—ãƒãƒ¯ã‚»ãƒ«ï¼ãƒ•ãƒ¤ã‚»ãƒ«\n\n\nã“ã®ãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ã‚µãƒãƒ¼ãƒˆã¯\nã‚‚ã£ã¨è³‡ç”£ã‚’å¢—ã‚„ã—ãŸã„ï¼\n\nã€Œãã‚“ãªäººã®ãŸã‚ã®ï¼–ï¼åˆ†ã€\n\n\nç¾æ™‚ç‚¹ã§ã”ä¸æ˜ç‚¹ãªã©ã¯\nã”ã•ã„ã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ã€‚\n\nä½•ã‹ã”ã–ã„ã¾ã—ãŸã‚‰\nãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚\n\n\nãã‚Œã§ã¯ã€\n${selectedCustomerName}æ§˜ã¨ãŠè©±ã§ãã‚‹ã“ã¨\næ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\næœ¬æ—¥ã¯ã©ã†ãã€\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\nâ€»â€»ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«å³ç¦â€»â€»\n\nä½•ã‹ã—ã‚‰ã®ã”äº‹æƒ…ã§\nã”å‚åŠ ãŒé›£ã—ã„ã¨ã„ã†å ´åˆã¯\näº‹å‰ã«ã”ä¸€å ±ãã ã•ã„ã€‚\n\nã”å”åŠ›ã®ã»ã©ã€\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

        copyText(reminderText, "ãƒªãƒã‚¤ãƒ³ãƒ‰æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰");

        selectedCustomerName = "";
        selectedMeetUrl = "";
        document.querySelectorAll('tr').forEach(t => t.classList.remove('selected'));
        nameDisplay.textContent = "";
    };

    dateEl.onchange = renderPreview;
    timeEl.onchange = renderPreview;
    methodEl.onchange = renderPreview;

    document.getElementById('searchInput').onkeyup = (e) => {
        currentSelectedDateStr = ""; renderCalendar();
        const val = e.target.value.toLowerCase();
        renderList(sortDataByDateDesc(allData.filter(row => row.join(" ").toLowerCase().includes(val))));
    };

    document.getElementById('btnGenerateMeet').onclick = async () => {
        if(!confirm("ã€å…¨ãƒ‡ãƒ¼ã‚¿å¯¾è±¡ã€‘\næœªç™ºè¡Œã®äºˆç´„ã«å¯¾ã—ã¦ã€Meetãƒªãƒ³ã‚¯ã‚’ä¸€æ‹¬ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
        await callApi("generateLinks", {}, "btnGenerateMeet", "å…¨ç™ºè¡Œä¸­...");
    };
    document.getElementById('btnGenerateMeetForDate').onclick = async () => {
        if(!currentSelectedDateStr) { alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        const formattedDate = currentSelectedDateStr.replace(/\./g, '-');
        if(!confirm(`ã€${formattedDate} ã®ã¿å¯¾è±¡ã€‘\nã“ã®æ—¥ã®æœªç™ºè¡Œäºˆç´„ã«å¯¾ã—ã¦ã€Meetãƒªãƒ³ã‚¯ã‚’ä¸€æ‹¬ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await callApi("generateLinksForDate", { date: formattedDate }, "btnGenerateMeetForDate", "ç™ºè¡Œä¸­...");
    };
    document.getElementById('btnDeleteDayBatch').onclick = async () => {
        if(!currentSelectedDateStr) { alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ãŸã„æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        if(!confirm(`ã€æ³¨æ„ã€‘\n${currentSelectedDateStr.replace(/\./g,'-')} ã®ãƒªãƒ³ã‚¯ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await callApi("deleteDayBatch", { date: currentSelectedDateStr.replace(/\./g,'-') }, "btnDeleteDayBatch", "å…¨å‰Šé™¤ä¸­...");
    };
    document.getElementById('btnCreateSingle').onclick = async () => {
        if(!selectedCustomerName) { alert("ãƒªã‚¹ãƒˆã‹ã‚‰äººã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        if(!confirm(`ã€å€‹åˆ¥ç™ºè¡Œã€‘\n${selectedCustomerName} æ§˜ã®ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await callApi("createSingle", { date: dateEl.value, time: timeEl.value, name: selectedCustomerName }, "btnCreateSingle", "ç™ºè¡Œä¸­...");
    };
    
    document.getElementById('btnCancelStatus').onclick = async () => {
        if(!selectedCustomerName) { alert("ãƒªã‚¹ãƒˆã‹ã‚‰äººã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        if(!confirm(`ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€‘\n${selectedCustomerName} æ§˜ã®äºˆç´„ã‚’ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã«ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã¯å‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ã‚¹ãƒ—ã‚·ã®è¡Œã¨Meetå±¥æ­´ã¯æ®‹ã‚Šã¾ã™\nãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã«ãªã‚Šã¾ã™`)) return;
        await callApi("cancelStatus", { date: dateEl.value, time: timeEl.value, name: selectedCustomerName }, "btnCancelStatus", "ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­...");
        alert("å‡¦ç†å®Œäº†ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤‰æ›´ã—ã¾ã—ãŸ");
    };

    document.getElementById('btnDeleteSingle').onclick = async () => {
        if(!selectedCustomerName) { alert("ãƒªã‚¹ãƒˆã‹ã‚‰äººã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        if(!confirm(`ã€å€‹åˆ¥å‰Šé™¤ã€‘\n${selectedCustomerName} æ§˜ã®ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await callApi("deleteSingle", { date: dateEl.value, time: timeEl.value, name: selectedCustomerName }, "btnDeleteSingle", "å‰Šé™¤ä¸­...");
    };

    document.getElementById('btnAddManual').onclick = async () => {
        const d = addDateEl.value;
        const t = addTimeEl.value;
        const n = addNameEl.value;
        const s = addStatusEl.value;
        const m = addMethodEl.value;

        if(!d || !n) { alert("æ—¥ä»˜ã¨ãŠåå‰ã¯å¿…é ˆã§ã™"); return; }
        if(!confirm(`${d} ${t}æ™‚ï½\n${n} æ§˜\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${s}\né¢è«‡æ–¹å¼: ${m}\n\nã“ã®å†…å®¹ã§äºˆç´„ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        
        const formattedDate = d.replace(/-/g, '.');
        const formattedTime = (t.length === 1 ? '0' + t : t) + ":00";
        const key = `method_${formattedDate}_${formattedTime}_${n}`;
        localStorage.setItem(key, m);

        await callApi("manualAdd", { date: d, time: t + ":00", name: n, status: s }, "btnAddManual", "è¿½åŠ ä¸­...");
        addNameEl.value = "";
        alert("è¿½åŠ ã—ã¾ã—ãŸï¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚");
        loadData();
    };

    document.getElementById('btnDeleteRow').onclick = async () => {
        if(!selectedCustomerName) { alert("ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ãŸã„äººã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        if(!confirm(`ã€äºˆç´„å‰Šé™¤ã€‘\n${selectedCustomerName} æ§˜ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã¯å‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒ„ãƒ¼ãƒ«ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆãˆã¾ã™\nãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã€Œå‰Šé™¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ®‹ã‚Šã¾ã™`)) return;
        
        const btn = document.getElementById("btnDeleteRow");
        btn.textContent = "å‰Šé™¤å‡¦ç†ä¸­..."; btn.disabled = true;

        try {
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "cancelStatus", date: dateEl.value, time: timeEl.value, name: selectedCustomerName }) 
            });
            await new Promise(r => setTimeout(r, 500)); 
            const response = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "updateStatus", date: dateEl.value, time: timeEl.value, name: selectedCustomerName, newStatus: "å‰Šé™¤" }) 
            });
            
            alert("å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸï¼‰");
            selectedCustomerName = "";
            loadData();
        } catch(e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            btn.textContent = "âŒ äºˆç´„å‰Šé™¤"; btn.disabled = false;
        }
    };

    document.getElementById('btnAssignStaff').onclick = async () => {
        if(!currentSelectedDateStr) { alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        const count = parseInt(assignStaffCountEl.value);
        const formattedDate = currentSelectedDateStr; 
        
        if(!confirm(`ã€æ‹…å½“å‰²ã‚ŠæŒ¯ã‚Šã€‘\næ—¥ä»˜: ${formattedDate}\nç¨¼åƒäººæ•°: ${count}äºº\n\nã€Œäºˆç´„ç¢ºå®šã€ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰²ã‚ŠæŒ¯ã‚Šã¾ã™ã‹ï¼Ÿ`)) return;
        
        let targets = [];
        allData.forEach(row => {
            const rowDate = String(row[2]);
            if(rowDate && rowDate.includes(formattedDate)) { 
                const status = String(row[5]||"");
                
                // äºˆç´„ç¢ºå®šç³»ã®ã¿æŠ½å‡º
                if (status !== "äºˆç´„ç¢ºå®š" && status !== "äºˆç´„ç¢ºå®šï¼ˆæ‰‹å‹•è¿½åŠ ï¼‰") return;
                
                const tStr = String(row[3]);
                const parts = tStr.split(":");
                const minutes = parseInt(parts[0])*60 + (parseInt(parts[1])||0);
                
                const name = row[12]||row[6]||"ãªã—";
                
                targets.push({
                    row: row,
                    time: minutes,
                    name: name,
                    key: `assign_${row[2]}_${row[3]}_${name}`
                });
            }
        });
        
        if(targets.length === 0) { alert("å‰²ã‚ŠæŒ¯ã‚Šå¯¾è±¡ã®ã€Œäºˆç´„ç¢ºå®šã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"); return; }
        
        targets.sort((a,b) => a.time - b.time);
        
        let staffState = [];
        for(let i=1; i<=count; i++) {
            staffState.push({ id: i, lastTime: -999, count: 0 });
        }
        
        let assignedCount = 0;
        
        targets.forEach(task => {
            let candidates = staffState.map(s => {
                let penalty = 0;
                if (task.time - s.lastTime <= 60) penalty += 10000;
                if (task.time - s.lastTime <= 120) penalty += 500;
                penalty += (s.count * 100);
                penalty += Math.floor(Math.random() * 50);
                return { id: s.id, penalty: penalty };
            });
            
            candidates.sort((a,b) => a.penalty - b.penalty);
            const winnerId = candidates[0].id;
            const winnerState = staffState.find(s => s.id === winnerId);
            winnerState.lastTime = task.time;
            winnerState.count++;
            
            const char = String.fromCharCode(64 + winnerId) + "ã•ã‚“";
            localStorage.setItem(task.key, char);
            assignedCount++;
        });
        
        alert(`${assignedCount}ä»¶ã®å‰²ã‚ŠæŒ¯ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼\nï¼ˆè¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ï¼‰`);
        
        if (currentSelectedDateStr) filterListByDate(currentSelectedDateStr);
        else renderList(sortDataByDateDesc(allData));
    };
  }

  window.updatePayment = async (date, time, name, value) => {
      await callApi("updatePayment", { date: date, time: time, name: name, method: value }, "null", "æ›´æ–°ä¸­...");
  };

  window.updateAssignLocal = (date, time, name, value) => {
      const key = `assign_${date}_${time}_${name}`;
      localStorage.setItem(key, value);
  };

  async function callApi(action, params, btnId, loadingText) {
    let btn = null;
    let originalText = "";
    if (btnId !== "null") {
        btn = document.getElementById(btnId);
        originalText = btn.textContent;
        btn.textContent = loadingText; btn.disabled = true;
    }
    
    try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: action, ...params }) });
        const result = await response.json();
        if(action !== "manualAdd" && action !== "deleteRow") { alert(result.message); loadData(); }
    } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); } 
    finally { if(btn) { btn.textContent = originalText; btn.disabled = false; } }
  }

  function loadData() {
    document.getElementById('loading').style.display = 'block';
    fetch(API_URL).then(res => res.json()).then(data => {
        allData = data;
        
        const paymentOrder = [
            "éŠ€æŒ¯ä¸€æ‹¬",
            "ã‚¯ãƒ¬ã‚«ä¸€æ‹¬",
            "ã‚¯ãƒ¬ã‚« 6åˆ†å‰²",
            "ã‚¯ãƒ¬ã‚« 12åˆ†å‰²",
            "ã‚¯ãƒ¬ã‚« 24åˆ†å‰²",
            "ã‚¯ãƒ¬ã‚« 36åˆ†å‰²",
            "ã‚¯ãƒ¬ã‚« 48åˆ†å‰²"
        ];
        
        const counts = {};
        let totalPaid = 0;
        
        allData.forEach(row => {
            const status = String(row[5] || "");
            let payment = String(row[20] || "").trim();
            
            if (normalizeMap[payment]) {
                payment = normalizeMap[payment];
            }

            if (status !== "å‰Šé™¤" && payment !== "") {
                totalPaid++;
                counts[payment] = (counts[payment] || 0) + 1;
            }
        });

        const titleEl = document.querySelector(".payment-total-title");
        titleEl.textContent = `ğŸ’° åˆè¨ˆå…¥é‡‘ä»¶æ•°ï¼š${totalPaid} ä»¶`;

        let detailHtml = "";
        let displayedCount = 0;
        
        if (totalPaid > 0) {
            paymentOrder.forEach(key => {
                if (counts[key] && counts[key] > 0) {
                    detailHtml += `<div class="payment-row"><span>${key}</span><span><b>${counts[key]}</b> ä»¶</span></div>`;
                    displayedCount++;
                }
            });
            for (const [key, val] of Object.entries(counts)) {
                if (!paymentOrder.includes(key)) {
                    detailHtml += `<div class="payment-row"><span>${key}</span><span><b>${val}</b> ä»¶</span></div>`;
                    displayedCount++;
                }
            }
        }
        
        if (displayedCount === 0) {
            detailHtml = "<div style='text-align:center; color:#999; font-size:12px;'>ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>";
        }
        
        paymentDetailList.innerHTML = detailHtml;

        if (currentSelectedDateStr) filterListByDate(currentSelectedDateStr);
        else renderList(sortDataByDateDesc(allData)); 
        renderCalendar();
        document.getElementById('loading').style.display = 'none';
        
        // åˆ†å‰²æ™‚ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¸¡æ–¹è¡¨ç¤º
        document.getElementById('salesTable').style.display = 'table';
        document.getElementById('supportTable').style.display = 'table';
        
    }).catch(err => {
        document.getElementById('loading').textContent = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    });
  }

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid'); grid.innerHTML = "";
    ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(w => {
        const d = document.createElement('div'); d.className = "cal-cell cal-head"; d.textContent = w;
        if(w==="æ—¥") d.style.color = "#ef4444"; if(w==="åœŸ") d.style.color = "#3b82f6";
        grid.appendChild(d);
    });
    const y = calDate.getFullYear(), m = calDate.getMonth();
    document.getElementById('calendarTitle').textContent = `${y}å¹´ ${m+1}æœˆ`;
    const first = new Date(y, m, 1), last = new Date(y, m+1, 0);
    for(let i=0; i<first.getDay(); i++) grid.appendChild(document.createElement('div'));
    
    for(let d=1; d<=last.getDate(); d++) {
        const div = document.createElement('div'); div.className = "cal-cell"; div.textContent = d;
        const targetStr = `${y}.${('0'+(m+1)).slice(-2)}.${('0'+d).slice(-2)}`;
        const check = new Date(y, m, d);
        if(check.getDay()===6) div.classList.add("cal-sat");
        else if(check.getDay()===0 || isHoliday(y, m+1, d)) div.classList.add("cal-sun");
        const today = new Date();
        if(y===today.getFullYear() && m===today.getMonth() && d===today.getDate()) div.classList.add("cal-today");
        if(allData.some(r => r[2] && r[2].includes(targetStr))) div.classList.add("cal-has-event");
        if(targetStr === currentSelectedDateStr) div.classList.add("cal-selected");
        div.onclick = () => { currentSelectedDateStr = targetStr; renderCalendar(); filterListByDate(targetStr); };
        grid.appendChild(div);
    }
  }

  // â–¼â–¼â–¼ ä¿®æ­£ï¼šrenderListã‚’åˆ†å‰²å¯¾å¿œ â–¼â–¼â–¼
  function renderList(data, isFiltered=false) {
    const salesTbody = document.getElementById('salesTableBody');
    const supportTbody = document.getElementById('supportTableBody');
    
    salesTbody.innerHTML = "";
    supportTbody.innerHTML = "";
    
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®è¡¨ç¤º
    if(data.length === 0) { 
        salesTbody.innerHTML = "<tr><td colspan='10' style='text-align:center; color:#999;'>ãªã—</td></tr>";
        supportTbody.innerHTML = "<tr><td colspan='10' style='text-align:center; color:#999;'>ãªã—</td></tr>";
        return; 
    }
    
    const salesFragment = document.createDocumentFragment();
    const supportFragment = document.createDocumentFragment();
    
    // è©²å½“ã™ã‚‹è¡ŒãŒã‚ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    let hasSales = false;
    let hasSupport = false;

    const today = new Date();
    const todayStr = `${today.getFullYear()}.${('0'+(today.getMonth()+1)).slice(-2)}.${('0'+today.getDate()).slice(-2)}`;
    const highlight = isFiltered && (currentSelectedDateStr === todayStr);
    let hTime = null;
    if (highlight) {
        const now = new Date();
        const next = data.find(r => {
            const t = r[3]; if(!t) return false;
            const d = new Date(); d.setHours(t.split(":")[0], t.split(":")[1]||0, 0, 0);
            return d > now;
        });
        if(next) hTime = next[3];
    }

    data.forEach(row => {
      const statusStr = String(row[5] || "");
      if (statusStr === "å‰Šé™¤") return;

      const tr = document.createElement('tr'); tr.className = "clickable";
      
      if (statusStr.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) {
          tr.classList.add("row-canceled");
      }
      
      const paymentVal = String(row[20] || "").trim();
      if (paymentVal !== "") {
          tr.classList.add("row-paid");
      }

      const name = row[12]||row[6]||"ãªã—";
      if(highlight && hTime && row[3]===hTime) tr.classList.add("highlight-next");
      
      const meetUrl = row[18] ? `<a href="${row[18]}" target="_blank" class="meet-link">ğŸ“¹å‚åŠ </a>` : "";
      const accountBadge = row[19] ? `<span class="account-badge">${row[19]}</span>` : '<span style="font-size:10px;color:#ddd;">-</span>';
      
      const copyBtn = row[18] ? `<button class="copy-link-btn" title="ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼" onclick="event.stopPropagation(); copyToClipboard('${row[18]}')">ğŸ“‹</button>` : "";
      
      let statusClass = "";
      if (statusStr === "åˆå›é¢è«‡") statusClass = "status-red";
      else if (statusStr.includes("ãƒµæœˆé¢è«‡")) statusClass = "status-blue";
      else if (statusStr === "æº€æœŸé¢è«‡") statusClass = "status-orange";

      let displayVal = paymentVal;
      if (normalizeMap[paymentVal]) displayVal = normalizeMap[paymentVal];

      const paymentOptions = [
          { val: "", label: "æœª (å‰Šé™¤)" }, 
          { val: "éŠ€æŒ¯ä¸€æ‹¬", label: "ğŸ’° éŠ€æŒ¯ä¸€æ‹¬" },
          { val: "ã‚¯ãƒ¬ã‚«ä¸€æ‹¬", label: "ğŸ’³ ã‚¯ãƒ¬ã‚«ä¸€æ‹¬" },
          { val: "ã‚¯ãƒ¬ã‚« 6åˆ†å‰²", label: "ğŸ’³ åˆ†å‰²6å›" },
          { val: "ã‚¯ãƒ¬ã‚« 12åˆ†å‰²", label: "ğŸ’³ åˆ†å‰²12å›" },
          { val: "ã‚¯ãƒ¬ã‚« 24åˆ†å‰²", label: "ğŸ’³ åˆ†å‰²24å›" },
          { val: "ã‚¯ãƒ¬ã‚« 36åˆ†å‰²", label: "ğŸ’³ åˆ†å‰²36å›" },
          { val: "ã‚¯ãƒ¬ã‚« 48åˆ†å‰²", label: "ğŸ’³ åˆ†å‰²48å›" }
      ];
      let paymentSelectHtml = `<select class="common-select" onclick="event.stopPropagation()" onchange="updatePayment('${row[2]}', '${row[3]}', '${name}', this.value)">`;
      paymentOptions.forEach(opt => {
          const isSelected = displayVal === opt.val ? "selected" : "";
          paymentSelectHtml += `<option value="${opt.val}" ${isSelected}>${opt.label}</option>`;
      });
      paymentSelectHtml += `</select>`;

      const methodKey = `method_${row[2]}_${row[3]}_${name}`;
      const savedMethod = localStorage.getItem(methodKey) || "Google Meet";
      const methodOptions = ["Google Meet", "é›»è©±", "LINE", "ãƒ¡ãƒ¼ãƒ«", "ãã®ä»–"];
      let methodSelectHtml = `<select class="common-select" onclick="event.stopPropagation()" onchange="updateMethod('${methodKey}', this.value)">`;
      methodOptions.forEach(opt => {
          methodSelectHtml += `<option ${opt === savedMethod ? 'selected' : ''}>${opt}</option>`;
      });
      methodSelectHtml += `</select>`;

      const assignKey = `assign_${row[2]}_${row[3]}_${name}`;
      const currentAssign = localStorage.getItem(assignKey) || "";
      const staffList = ["Aã•ã‚“", "Bã•ã‚“", "Cã•ã‚“", "Dã•ã‚“", "Eã•ã‚“", "Fã•ã‚“", "Gã•ã‚“", "Hã•ã‚“"];
      
      let assignSelectHtml = `<select class="common-select" style="min-width:60px;" onclick="event.stopPropagation()" onchange="updateAssignLocal('${row[2]}', '${row[3]}', '${name}', this.value)">`;
      assignSelectHtml += `<option value="" ${currentAssign === "" ? "selected" : ""}>-</option>`;
      staffList.forEach(staff => {
          const isSelected = currentAssign === staff ? "selected" : "";
          assignSelectHtml += `<option value="${staff}" ${isSelected}>${staff}</option>`;
      });
      assignSelectHtml += `</select>`;

      tr.innerHTML = `<td>${row[2]}</td><td>${row[3]}</td><td style="font-weight:bold">${name}</td><td class="${statusClass}">${row[5]}</td><td>${methodSelectHtml}</td><td>${assignSelectHtml}</td><td>${accountBadge}</td><td>${meetUrl}</td><td>${copyBtn}</td><td>${paymentSelectHtml}</td>`;
      tr.onclick = () => {
        document.querySelectorAll('tr').forEach(t => t.classList.remove('selected'));
        tr.classList.add('selected');
        if(row[2]) dateEl.value = safeDate(row[2]);
        if(row[3]) timeEl.value = String(parseInt(row[3]));
        selectedCustomerName = name;
        nameDisplay.textContent = `é¸æŠä¸­: ${name}`;
        selectedMeetUrl = row[18];
        const currentMethod = localStorage.getItem(methodKey) || "Google Meet";
        const methodEl = document.getElementById("method");
        methodEl.value = currentMethod;
        renderPreview();
        if(window.innerWidth < 600) document.getElementById('toolBox').scrollIntoView({behavior:"smooth"});
      };

      // â˜…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šã«ã‚ˆã‚‹æŒ¯ã‚Šåˆ†ã‘
      if (statusStr.includes("äºˆç´„ç¢ºå®š")) {
          salesFragment.appendChild(tr);
          hasSales = true;
      } else {
          supportFragment.appendChild(tr);
          hasSupport = true;
      }
    });

    if(!hasSales) salesTbody.innerHTML = "<tr><td colspan='10' style='text-align:center; color:#999;'>ãªã—</td></tr>";
    else salesTbody.appendChild(salesFragment);

    if(!hasSupport) supportTbody.innerHTML = "<tr><td colspan='10' style='text-align:center; color:#999;'>ãªã—</td></tr>";
    else supportTbody.appendChild(supportFragment);
  }

  window.updateMethod = (key, value) => {
      localStorage.setItem(key, value);
      const methodEl = document.getElementById("method");
      methodEl.value = value;
      const event = new Event('change');
      methodEl.dispatchEvent(event);
  };

  window.copyToClipboard = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      const statusEl = document.getElementById("status");
      statusEl.textContent = "ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ğŸ“‹";
      setTimeout(() => statusEl.textContent = "", 2000);
    } catch (err) {
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  // Util
  function safeDate(s) { const m=s.match(/(\d{4})[\.\/\-](\d{1,2})[\.\/\-](\d{1,2})/); return m?`${m[1]}-${m[2]}-${m[3]}`:""; }
  function isHoliday(y, m, d) { return ["2025-01-01","2025-01-13","2025-02-11","2025-02-23","2025-02-24","2025-03-20","2025-04-29","2025-05-03","2025-05-04","2025-05-05","2025-05-06","2025-07-21","2025-08-11","2025-09-15","2025-09-23","2025-10-13","2025-11-03","2025-11-23","2025-11-24","2026-01-01","2026-01-12","2026-02-11","2026-02-23","2026-03-21","2026-04-29","2026-05-03","2026-05-04","2026-05-05","2026-05-06","2026-07-20","2026-08-11","2026-09-21","2026-09-23","2026-10-12","2026-11-03","2026-11-23"].includes(`${y}-${('0'+m).slice(-2)}-${('0'+d).slice(-2)}`); }
  
  function getNumericDate(str) {
      if(!str) return 0;
      const s = str.replace(/[^\d]/g, ""); 
      return parseInt(s) || 0; 
  }
  function parseTime(tStr) {
      if (!tStr) return 9999;
      const parts = String(tStr).split(":");
      return parseInt(parts[0]) * 60 + (parseInt(parts[1]) || 0);
  }

  function sortDataByDateDesc(dataList) {
    return dataList.sort((a, b) => {
        const dA = getNumericDate(a[2]); const dB = getNumericDate(b[2]);
        if (dA !== dB) return dB - dA; 
        return parseTime(a[3]) - parseTime(b[3]); 
    });
  }
  function sortDataByTime(dataList) { return dataList.sort((a,b)=>parseTime(a[3]) - parseTime(b[3])); }

  function filterListByDate(targetDateStr) {
    const filtered = allData.filter(row => row[2] && row[2].includes(targetDateStr));
    renderList(sortDataByTime(filtered), true); 
  }

  function fmtDateParts() { const v=dateEl.value; if(!v)return null; const d=new Date(v+"T00:00:00"); return {y:d.getFullYear(),m:d.getMonth()+1,d:d.getDate(),w:week[d.getDay()],h:timeEl.value,mt:methodEl.value}; }
  function buildDateBox() { const p=fmtDateParts(); return p?`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\né¢è«‡äºˆç´„æ—¥æ™‚\n${p.y}å¹´${p.m}æœˆ${p.d}æ—¥ï¼ˆ${p.w}ï¼‰\n${p.h}æ™‚ï½é¢è«‡é–‹å§‹\næ–¹æ³•ï¼š${p.mt}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`:""; }
  function buildFullMessage() { return `ãƒ•ãƒ¤ã‚»ãƒ«ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚\nã”é€£çµ¡ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\n${buildDateBox()}\n\nã”æŒ‡å®šã®ãŠæ™‚é–“ã«\nç©ºãæ ãŒã”ã–ã„ã¾ã—ãŸã®ã§\nä¸Šè¨˜æ—¥ç¨‹ã«ã¦é¢è«‡ã«\nå…¥ã‚‰ã›ã¦ã„ãŸã ãã¾ã™ã€‚\n\né¢è«‡ã®éš›ã«ã¯\n\nã€Œãƒ•ãƒ¤ã‚»ãƒ«AIã®æº–å‚™ã€\nã€ŒèããŸã„ã“ã¨ã€\nã€Œã‚µãƒãƒ¼ãƒˆã‚’å—ã‘ãŸã„ã“ã¨ã€\n\nã“ã¡ã‚‰ã‚’ã”ç”¨æ„ãƒ»ã”æº–å‚™ã®ã†ãˆ\nã”å‚åŠ ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚\n\nãã®é–“ã§ã‚‚\nã”è³ªå•ãªã©ãŒã”ã–ã„ã¾ã—ãŸã‚‰\n\nã—ã£ã‹ã‚Šä¸å¯§ã«ã‚µãƒãƒ¼ãƒˆå¯¾å¿œã‚’\nã•ã›ã¦ã„ãŸã ãã¾ã™ã®ã§\n\nã”ä¸æ˜ç‚¹ãŒã”ã–ã„ã¾ã™å ´åˆã¯\nãŠå•ã„åˆã‚ã›ãã ã•ã„ã¾ã›ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`; }
  function renderPreview() { const t=buildFullMessage(); previewEl.value=t||"æ—¥ä»˜ã‚’é¸ã¶ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‡ºã¾ã™"; statusEl.textContent=""; }
  async function copyText(t,m) { if(!t){statusEl.textContent="æ—¥ä»˜ã‚¨ãƒ©ãƒ¼";return;} try{await navigator.clipboard.writeText(t);statusEl.textContent=m;}catch{previewEl.select();document.execCommand("copy");statusEl.textContent=m;} setTimeout(()=>statusEl.textContent="",1500); }

  init();
})();
</script>
</body>
</html>
